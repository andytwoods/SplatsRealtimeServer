{% extends "base.html" %}


{% block js %}
    <script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock js %}

{% block css %}

    <style>
        video {
            width: 500px;
            height: 400px;
            object-fit: cover;
        }

    </style>
{% endblock css %}

{% block content %}
    <section>
        <div id="liveView" class="videoView">
            <button id="webcamButton" class="mdc-button mdc-button--raised">
                <span class="mdc-button__ripple"></span>
                <span class="mdc-button__label">ENABLE WEBCAM</span>
            </button>
            <div style="position: relative;">
                <video id="webcam" autoplay playsinline></video>
                <canvas class="output_canvas" id="output_canvas" width="1280" height="720"
                        style="position: absolute; left: 0px; top: 0px;"></canvas>
                <p id='gesture_output' class="output">
            </div>
        </div>
    </section>

    <script type="text/javascript">

        // https://stackoverflow.com/a/36712522/960471
        function newGradient() {

            function shuffle(array) {
                let currentIndex = array.length;

                // While there remain elements to shuffle...
                while (currentIndex != 0) {

                    // Pick a remaining element...
                    let randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;

                    // And swap it with the current element.
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
            }

            var cols = "AliceBlue,AntiqueWhite,Aqua,Aquamarine,Azure,Beige,Bisque,Black,BlanchedAlmond,Blue,BlueViolet,Brown,BurlyWood,CadetBlue,Chartreuse,Chocolate,Coral,CornflowerBlue,Cornsilk,Crimson,Cyan,DarkBlue,DarkCyan,DarkGoldenrod,DarkGray,DarkGreen,DarkKhaki,DarkMagenta,DarkOliveGreen,DarkOrange,DarkOrchid,DarkRed,DarkSalmon,DarkSeaGreen,DarkSlateBlue,DarkSlateGray,DarkTurquoise,DarkViolet,DeepPink,DeepSkyBlue,DimGray,DodgerBlue,FireBrick,FloralWhite,ForestGreen,Fuchsia,Gainsboro,GhostWhite,Gold,Goldenrod,Gray,Green,GreenYellow,HoneyDew,HotPink,Indigo,Ivory,Khaki,Lavender,LavenderBlush,LawnGreen,LemonChiffon,LightBlue,LightCoral,LightCyan,LightGoldenrodYellow,LightGray,LightGreen,LightPink,LightSalmon,LightSalmon,LightSeaGreen,LightSkyBlue,LightSlateGray,LightSteelBlue,LightYellow,Lime,LimeGreen,Linen,Magenta,Maroon,MediumAquamarine,MediumBlue,MediumOrchid,MediumPurple,MediumSeaGreen,MediumSlateBlue,MediumSlateBlue,MediumSpringGreen,MediumTurquoise,MediumVioletRed,MidnightBlue,MintCream,MistyRose,Moccasin,NavajoWhite,Navy,OldLace,Olive,OliveDrab,Orange,OrangeRed,Orchid,PaleGoldenrod,PaleGreen,PaleTurquoise,PaleVioletRed,PapayaWhip,PeachPuff,Peru,Pink,Plum,PowderBlue,Purple,RebeccaPurple,Red,RosyBrown,RoyalBlue,SaddleBrown,Salmon,SandyBrown,SeaGreen,SeaShell,Sienna,Silver,SkyBlue,SlateBlue,SlateGray,Snow,SpringGreen,SteelBlue,Tan,Teal,Thistle,Tomato,Turquoise,Violet,Wheat,White,WhiteSmoke,Yellow,YellowGreen".split(",");
            shuffle(cols);

            function rand_percent() {
                return Math.round(Math.random() * 100, 0) + "%"

            }

            var grad = 'radial-gradient(circle at 65% 15%, white 1px, ' + cols[0] + ' ' + rand_percent() +
                ', ' + cols[1] + ' ' + rand_percent() + ', ' + cols[2] + ' ' + rand_percent() + ')';

            return grad;
        }

        function makeid(length) {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charactersLength = characters.length;
            let counter = 0;
            while (counter < length) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
                counter += 1;
            }
            return result;
        }

        let ws;
        let id = makeid(4);

        const balls = (function () {

            let api = {}
            let all_balls = {};

            function gen_ball(id) {
                let div = document.createElement("div");
                div.id = id;
                div.className = "ball"
                div.style.background = newGradient();
                document.body.appendChild(div);
            }

            api.move = function (ball_info, this_id) {
                const ball_id = ball_info['id'];
                if (all_balls[ball_id] === undefined) {
                    console.log(ball_id)
                    gen_ball(ball_id);
                    all_balls[ball_id] = {data: {}}
                }
                all_balls[ball_id] = {data: ball_info.data}

                if (this_id || all_balls[ball_id] !== id)

                    if (this_id || (!this_id && all_balls[ball_id] !== id)) {
                        const ball = document.getElementById(ball_id);
                        let screen_width = window.screen.width;
                        let screen_height = window.screen.height;

                        //orientation utter rubbish JS chaos
                        if (screen_width < screen_height) {
                            var temp = screen_width;
                            screen_width = screen_width;
                            screen_height = temp;
                        }
                        const ball_diameter = 50 - ball_info.data.z * 5 + 50;

                        let left = screen_width * .5 - (ball_diameter * .25) - ball_info.data.x * 50;
                        let top = screen_height * .5 + (ball_diameter * 1.25) + ball_info.data.y * 200;


                        if (top > (screen_height - ball_diameter)) top = screen_height - ball_diameter;
                        if (left > (screen_width - ball_diameter)) left = screen_width - ball_diameter;

                        if (top < 0) top = 0;
                        if (left < 0) left = 0;

                        // console.log(top, left)
                        gsap.to(ball, {
                            left: left,
                            top: top,
                            width: ball_diameter,
                            height: ball_diameter
                        })
                    }
            }

            return api
        }());
        let linking = true;

        function link_ws() {
            console.log('linking...')
            const _ws = new WebSocket(`wss://${location.host}/ws`);

            _ws.addEventListener('message', function (event) {

                const ball_info = JSON.parse(event.data);
                if (ball_info.id === id) return;
                balls.move(ball_info);
                // const li = document.createElement("li");
                //li.appendChild(document.createTextNode(event.data));
                //document.getElementById("messages").appendChild(li);
            });

            function reconnect() {
                if (linking) return;
                else linking = true;
                _ws.close();
                ws = undefined;
                console.log('lost connection, relinking shortly...')
                setTimeout(function () {
                    link_ws();
                }, 1000);

            }

            _ws.addEventListener('close', reconnect);
            _ws.addEventListener('error', reconnect);
            _ws.addEventListener('open', function () {
                console.log('connected');
                linking = false;
                ws = _ws;
            });

            function send(event) {
                const message = (new FormData(event.target)).get("message");
                if (message) {
                    ws.send(message);
                }
                event.target.reset();
                return false;
            }
        }

        link_ws();

        const acl = new Accelerometer({frequency: 5});
        acl.addEventListener("reading", () => {
            var ball_data = {id: id, sensor: 'gyroscope', data: {x: acl.x, y: acl.y, z: acl.z}}
            var info_str = JSON.stringify(ball_data);
            balls.move(ball_data, true);
            if (!!ws) ws.send(info_str);
        });

        acl.start();
    </script>
    <div style="display: flex; height: 100%; flex-direction: column">
        <ul id="messages" style="flex-grow: 1; list-style-type: none"></ul>
    </div>
{% endblock %}